on:
  poll:
    url:
      # æ—¥å—(Canan)
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/83679"
      # Lenfried
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/17213"
      # ã‚¢ãƒ˜ä¸¸
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/5679"
      # æœˆä¹ƒã‚¦ã‚µã‚®
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/28905"
      # Nagisaé­”ç‰©å–µ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/17148"
      # ãƒ™ãƒ«ã‚¼
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/146867"
      # å¤ç›®ã¤ãªã‚Š(@Tsunapoe)
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/20001"
      # ãƒ”ãƒ³ã‚­ãƒ¼Web/Pinkyweb
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/1445"
      # ã›ã£ãã™ãµã‚Œã‚“ã©
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/1470"
      # åŒäººã‚¢ã‚­ãƒå‡ºç‰ˆ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/4483"
      # ãã‚ã“ã’ãƒãƒğŸ¼
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/29318"
      # ã™ã”ã„ç«
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/145129"
      # é•·ãã§
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/17096"
      # å²¡ç”°ã‚†ã„
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/16490"
      # ã„ã‚ãŠ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/478099"
      # ãµã‚‰ã†
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/2156"
      # å…«æœ¨æˆ¸ãƒãƒˆ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/105571"
      # ãƒ‡ã‚³åŠ©
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/14553"
      # ãƒ˜ãƒ«ã‚·ãƒ¼ãƒãƒ³
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/26643"
      # ã‚ã®ã‚“ï¼’å„„å¹´
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/6345"
      # ã‚ŠãŠâ¤ï¸â¤ï¸â¤ï¸
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/158016"
      # ã‚ŠãŠâ¤ï¸â¤ï¸â¤ï¸
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/33044"
      # ï¼‘å„„å¹´æƒ‘æ˜Ÿ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/214727"
      # å·¦é–€ã—ã†
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/61137"
      # ãƒ‹ãƒ¼ãƒˆç¤¾é•·
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/750"
      # horosuke
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/7439"
      # ã¨ã“ã¾ã‚„ã‘ã„ãŸ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/173796"
      # ã±ã™ãŸ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/292282"
      # ãŠã¨ãã¦ã¤ã‚ã†
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/52698"
      # èª¿å››å­£
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/17006"
      # ã‚³ãƒ³ãƒˆãƒ¬ãƒ³ã‚¸
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/40576"
      # ã‚«ã‚ªãƒ 
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/2065"
      # ãªã™ãª
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/14079"
      # akaomi
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/2820"
      # LK
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/32450"
      # ã‹ãªã¿ãƒ«ãƒœãƒ³
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/191567"
      # ã‚¼ãƒ„ãƒ¬ãƒƒãƒ‰
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/16749"
      # Rindou
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/29013"
      # ã‹ã™ã¿ï¼ ãƒã‚¤ãƒ‘ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚ªãƒŠãƒ‹ã‚¹ãƒˆ
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/16365"
      # vanadium
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/206952"
      # ç„¼è‚‰å¤§å¥½ãã‚ãã¡
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/376503"
      # ãƒ¢ã‚°ãƒ€ãƒ³
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/6099"
      # å«‰å¦¬ãƒã‚¹ã‚¯
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/82773"
      # éš£äººã¡ã‚ƒã‚“@é€æ˜ãƒãƒ‹ãƒ¼ğŸ°â¤
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/17185"
      # ã‹ã‚Šã‚“ğŸ‘»
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/420714"
      # ãƒãƒ¼ãƒãƒªã‚¢ãƒ³é«˜æœ¬
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/112298"
      # ã‚†ã‚†ã“
      - "https://api.tamakasu.ga/v1/kemono/posts/fantia/56489"
    itemsPath: items
    deduplicationKey: id
    buildOutputsOnError: true
    config:
      skipOnError: true
      format: |
        item.title = item.title.replace(/'/g, "'\\''");
        return item;
jobs:
  post:
    name: Post kemono-api updates to the discord
    runs-on: ubuntu-latest
    steps:
      - name: Fix
        id: fix
        run: |
          fix_title=$(echo '${{ on.poll.outputs.title }}' | sed "s/'/'\\\''/g" | sed 's/!/\\!/g;s/"/\\"/g;s/*/\\\\*/g;s/_/\\\\_/g;s/~~/\\\\~~/g')
          sourseName=$(awk -F "/" '{print $4}' <<<"${{ on.poll.outputs.contentUrl }}")
          userId=$(awk -F "/" '{print $6}' <<<"${{ on.poll.outputs.contentUrl }}")
          contentId=$(awk -F "/" '{print $8}' <<<"${{ on.poll.outputs.contentUrl }}")
          fix_url="https://${{ secrets.API_DOMAIN }}/v1/kemono/posts/${sourseName}/${userId}/${contentId}"
          echo "::set-output name=title::${fix_title}"
          echo "::set-output name=link::${fix_url}"
      - name: Post
        run: |
          {
            imageUrl=$(curl -s -H 'User-Agent: Discordbot' ${{ steps.fix.outputs.link }}|grep 'property="og:image"'|sed 's/^ *<meta property="og:image" content="//g;s/" \/>$//g')
            curl -s \
                 --retry 10 \
                 --retry-all-errors \
                 "${imageUrl}" > /dev/null 2>&1 || :
            curl -s \
                 -X POST \
                 --retry 10 \
                 --retry-all-errors \
                 -H "Content-Type: application/json" \
                 ${{ secrets.DISCORD_KEMONO_FANTIA }} \
                 -d '{"content": "**${{ steps.fix.outputs.title }}** ${{ steps.fix.outputs.link }}"}' || :
          } || exit 0
          sleep 1
