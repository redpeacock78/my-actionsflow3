on:
  poll:
    url:
      # ã‚ã‚ãŠã‚“
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/10920453"
      # SOS
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/85720459"
      # TRY
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/1340203"
      # ağŸ”
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/79145351"
      # tsurugi33
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/4994"
      # ã‚ã¾ãªãå…«é›²
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/82437945"
      # ä¸€æœ¬æ­
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/177996"
      # AoChoku
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/15860216"
      # å¹³æ²¢ï¼ ZenHirasawa
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/884634"
      # ãƒªã‚³ã‚·ã‚§ãƒƒãƒˆ
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/66409778"
      # butachang
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/79105"
      # ãªã¤ã¿ã‚“
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/733737"
      # 4UU
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/81635207"
      # å¤ç›®ãƒ™ãƒ³ã‚±ã‚¤
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/11339300"
      # å‘¨é˜²ãƒ‘ãƒˆãƒ©/Vtuber
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/92793665"
      # yapo
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/14089"
      # miga
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/896593"
      # ä¹ƒã€…æœ¨
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/28934049"
      # æ¾¤ç”°ã‚³ã‚¦ğŸ¦”
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/87689886"
      # ã½ã‚‹ã›ã‚Šã‚“
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/15209643"
      # horosuke
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/641955"
      # ãŸã@Skebå‹Ÿé›†ä¸­ãªã·ã„ã“ã­å‹¢
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/39814580"
      # æ ¹ç”°å•“å²
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/208166"
      # æœ‰éƒ½ã‚ã‚‰ã‚†ã‚‹
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/3733098"
      # é«˜é ãã‚åŠ©
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/596129"
      # ã‚¸ãƒ£ãƒƒã‚­ãƒ¼
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/826428"
      # KIYO
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/16208698"
      # giga
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/28238559"
      # ã¿ã™ã‚Šã‚‹ãƒªãƒ 
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/17239664"
      # mamaloni
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/36226075"
      # ã»ãŸã‚‹
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/86005408"
      # å§‰å·ã‚¨
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/61151588"
      # è€³ã‹ã
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/17382278"
      # ãªãã¨
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/3008144"
      # fan
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/50993448"
      # ã‚ãƒ¼ã¡
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/53657640"
      # ãƒãƒ­ãƒ­ãƒƒã‚«
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/1463539"
      # ğŸ”çµµæãå¤–å›½äºº
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/87004152"
      # çœŸåœ’ã‚ãã‚‰
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/32254838"
      # ã‚Šã‚“ã”çŠ¬
      - "https://my-api.redpeacock78.com/v1/kemono/posts/fanbox/2396"
    itemsPath: items
    deduplicationKey: id
    buildOutputsOnError: true
    config:
      skipOnError: true
      format: |
        item.title = item.title.replace(/'/g, "'\\''");
        return item;
jobs:
  post:
    name: Post kemono-api updates to the discord
    runs-on: ubuntu-latest
    steps:
      - name: Fix
        id: fix
        run: |
          fix_title=$(echo '${{ on.poll.outputs.title }}' | sed "s/'/'\\\''/g" | sed 's/!/\\!/g;s/"/\\"/g;s/*/\\\\*/g;s/_/\\\\_/g;s/~~/\\\\~~/g')
          sourseName=$(awk -F "/" '{print $4}' <<<"${{ on.poll.outputs.contentUrl }}")
          userId=$(awk -F "/" '{print $6}' <<<"${{ on.poll.outputs.contentUrl }}")
          contentId=$(awk -F "/" '{print $8}' <<<"${{ on.poll.outputs.contentUrl }}")
          fix_url="https://${{ secrets.API_DOMAIN }}/v1/kemono/posts/${sourseName}/${userId}/${contentId}"
          echo "::set-output name=title::${fix_title}"
          echo "::set-output name=link::${fix_url}"
      - name: Post
        run: |
          {
            imageUrl=$(curl -s --retry 10 --retry-all-errors -H 'User-Agent: Discordbot' ${{ steps.fix.outputs.link }}|grep 'property="og:image"'|sed 's/^ *<meta property="og:image" content="//g;s/" \/>$//g')
            curl -s \
                 --retry 10 \
                 --retry-all-errors \
                 "${imageUrl}" > /dev/null 2>&1 || :
            curl -s \
                 -X POST \
                 --retry 10 \
                 --retry-all-errors \
                 -H "Content-Type: application/json" \
                 ${{ secrets.DISCORD_KEMONO_FANBOX }} \
                 -d '{"content": "**${{ steps.fix.outputs.title }}** ${{ steps.fix.outputs.link }}"}' || :
          } || exit 0
          sleep 1
