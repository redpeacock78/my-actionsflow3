on:
  poll:
    url:
      # Gakelzfh
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/19719823"
      # Rmxs3488
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/12501034"
      # „ÅÜ„Çã„Çä„Å≤
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/12501034"
      # „ÇÄ„Å°
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/65092407"
      # „Åï„Åã„ÅÑ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/7140630"
      # fumihiko
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/2658856"
      # Èï∑„Åù„Åß
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/14356894"
      # maru54
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/151892"
      # sou-mikagami
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/267681"
      # Áå´‰πÉ„Åæ„Åü„Åü„Å≥
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/581626"
      # ËâØ„ÅèÁÖÆ„ÅüÂçµ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/20098597"
      # „Åä„ÇÇ„Å†„Åã
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/374142"
      # „ÇÇ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/5835340"
      # „Åè„Çç„Åü„Åæ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/272079"
      # Èõ≤‰∏π„Éî„Ç¢„Éé
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/65330886"
      # „Çå„ÇÇ„Å°
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/80695562"
      # „ÅÇ„Å£„Åè„Åô
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/717665"
      # „Å®„ÇÇ„Å§„ÅãÊ≤ªËá£
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/230418"
      # ÈÉÅ(„ÅÑ„Åè)
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/5476137"
      # reloco
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/70637112"
      # „Ç¢„É°
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/37644945"
      # „Çµ„Éº„É§
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/39908359"
      # „Åæ„Åü„Çì„Åî„ÇÄ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/2316546"
      # ie
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/24164271"
      # Cosine
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/2336"
      # Karin„Åã„Çä„Çì
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/18499718"
      # basuke
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/9329300"
      # 18„Éû„Çπ„Çø„Éº
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/39240212"
      # „Éü„É¢„Éç„É´
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/112519"
      # „Åä„Åç„Çá„ÅÜ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/18960704"
      # „Ç®„ÉìÁéã
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/63828616"
      # „Åä„Åä„Åä„Åä„ÅÇ„Çä„Åè„ÅÑ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/35801"
      # ulsyan
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/41183137"
      # Ê∞¥ËÅñ„ÅÆ„ÅÇ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/79095966"
      # TER„ÉÜ„Ç¢
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/206708"
      # susu
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/344729"
      # cham22
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/16456081"
      # „Çº„ÉÑ„É¨„ÉÉ„Éâ
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/2587756"
      # mamimi
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/17151277"
      # ÂØøÂè∏‰∫åÈÉé SushiJjiro
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/83835745"
      # „ÅÇ„Çç„Åä„Çì
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/10920453"
      # SOS
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/85720459"
      # TRY
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/1340203"
      # aüîû
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/79145351"
      # tsurugi33
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/4994"
      # „ÅÇ„Åæ„Å™„ÅéÂÖ´Èõ≤
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/82437945"
      # ‰∏ÄÊú¨Êù≠
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/177996"
      # AoChoku
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/15860216"
      # Âπ≥Ê≤¢Ôº†ZenHirasawa
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/884634"
      # „É™„Ç≥„Ç∑„Çß„ÉÉ„Éà
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/66409778"
      # butachang
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/79105"
      # „Å™„Å§„Åø„Çì
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/733737"
      # 4UU
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/81635207"
      # Â§èÁõÆ„Éô„É≥„Ç±„Ç§
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/11339300"
      # Âë®Èò≤„Éë„Éà„É©/Vtuber
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/92793665"
      # yapo
      - "https://api.redpeacock78.ml/v1/kemono/posts/fanbox/14089"
    itemsPath: items
    deduplicationKey: id
    buildOutputsOnError: true
    config:
      skipOnError: true
      format: |
        item.title = item.title.replace(/'/g, "'\\''");
        return item;
jobs:
  post:
    name: Post kemono-api updates to the discord
    runs-on: ubuntu-latest
    steps:
      - name: Fix
        id: fix
        run: |
          fix_title=$(echo '${{ on.poll.outputs.title }}' | sed "s/'/'\\\''/g" | sed 's/!/\\!/g;s/"/\\"/g;s/*/\\\\*/g;s/_/\\\\_/g;s/~~/\\\\~~/g')
          sourseName=$(awk -F "/" '{print $4}' <<<"${{ on.poll.outputs.contentUrl }}")
          userId=$(awk -F "/" '{print $6}' <<<"${{ on.poll.outputs.contentUrl }}")
          contentId=$(awk -F "/" '{print $8}' <<<"${{ on.poll.outputs.contentUrl }}")
          fix_url="https://${{ secrets.API_DOMAIN }}/v1/kemono/posts/${sourseName}/${userId}/${contentId}"
          echo "::set-output name=title::${fix_title}"
          echo "::set-output name=link::${fix_url}"
      - name: Post
        run: |
          {
            imageUrl=$(curl -s -H 'User-Agent: Discordbot' ${{ steps.fix.outputs.link }}|grep 'property="og:image"'|sed 's/^ *<meta property="og:image" content="//g;s/" \/>$//g')
            curl -s \
                 --retry 10 \
                 --retry-all-errors \
                 "${imageUrl}" > /dev/null 2>&1 || :
            curl -s \
                 -X POST \
                 --retry 10 \
                 --retry-all-errors \
                 -H "Content-Type: application/json" \
                 ${{ secrets.DISCORD_KEMONO_FANBOX }} \
                 -d '{"content": "**${{ steps.fix.outputs.title }}** ${{ steps.fix.outputs.link }}"}' || :
          } || exit 0
          sleep 1
